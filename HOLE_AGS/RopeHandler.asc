// Rope Handled script

function RopeLockEngaged() {
  // Is called in the main game loop
  // Checks down arrow key press state and sets gRopeLocked to true if key is NOT pressed
  
  if (IsKeyPressed(eKeyDownArrow) == true) {
    if (gScanTimer != 0) {
      return;
    }
    gRopeLocked = false;
    deLabSpeed.TextColor = 65535;
    return false;
  } else {
    gRopeLocked = true;
    deLabSpeed.TextColor = 64073;
    return true;
  }
} export RopeLockEngaged;

function ScanLocation() {
  int AnimationTimer = 0;
  int ScanObjectX = -1024;
  int ScanObjectY = -1024;
  
  if (guiScannerReticle.Visible == false) {
    gScanTimer = 0;
    return; // Scan had not started yet,  too short button press
  }
  // Check if scan found something
  if (Object.GetAtScreenXY(btnScannerReticle.X+10, btnScannerReticle.Y+10) != null) {
    ScanObjectX = btnScannerReticle.X+10;
    ScanObjectY = btnScannerReticle.Y+10;
  }
  
  if (Object.GetAtScreenXY(btnScannerReticle.X+5, btnScannerReticle.Y+10) != null) {
    ScanObjectX = btnScannerReticle.X+5;
    ScanObjectY = btnScannerReticle.Y+10;
  }
  
  if (Object.GetAtScreenXY(btnScannerReticle.X+15, btnScannerReticle.Y+10) != null) {
    ScanObjectX = btnScannerReticle.X+15;
    ScanObjectY = btnScannerReticle.Y+10;
  }
  
  if (Object.GetAtScreenXY(btnScannerReticle.X+10, btnScannerReticle.Y+5) != null) {
    ScanObjectX = btnScannerReticle.X+10;
    ScanObjectY = btnScannerReticle.Y+5;
  }
  
  if (Object.GetAtScreenXY(btnScannerReticle.X+10, btnScannerReticle.Y+15) != null) {
    ScanObjectX = btnScannerReticle.X+10;
    ScanObjectY = btnScannerReticle.Y+15;
  }
  // If something found,  trigger event
  if (ScanObjectX != -1024 && ScanObjectY != -1024) {
    btnScannerReticle.Animate(2, 1, 20, eRepeat, eNoBlock);
    AnimationTimer++;
    Wait(120);
    guiScannerReticle.Visible = false;
    gScanTimer = 0;
    
    Object*ScanTGT = Object.GetAtScreenXY(ScanObjectX, ScanObjectY);
    
    // Perform object detection checks here
    if (ScanTGT.Name == "POI") { // Are we scanning the object for first time?
      Display("SCORE!");
      gScore++;
      ScanTGT.Name = " ";
    } else {
      Display("Already scanned this one, nothing new here.");
    }
    return;
  }
  
  // If nothing found,  trigger fail animation and clear scanner
  btnScannerReticle.Animate(2, 2, 20, eRepeat, eNoBlock);
  AnimationTimer++;
  Wait(120);
  
  guiScannerReticle.Visible = false;
  gScanTimer = 0;
  return;
}

function FaceScan() {
  if (gRopeLocked == false) {
    return; // Rope is unlocked, player is moving, so exit
  }
  
  if (IsKeyPressed(eKeyLeftArrow) == false && IsKeyPressed(eKeyRightArrow) == false) {
    // Neither direction pressed, reset player view if not default or idle animation
    if (gScanTimer != 0) {
      // Scan was in progress so trigger scan check
      ScanLocation();
    }
    if (player.Loop == 8) {
      player.Animate(1, 1, eOnce, eNoBlock);
    }
    if (player.Loop == 9) {
      player.Animate(2, 1, eOnce, eNoBlock);
    }
  }
  
  // Handle left and right keypresses
  if (IsKeyPressed(eKeyLeftArrow) && IsKeyPressed(eKeyRightArrow)) {
    if (gScanTimer != 0) {
      // Scan was in progress so trigger scan check
      ScanLocation();
    }
    return; // Both directions pressed,  do nothing, screw the player trying to be fancy
  }
  
  if (IsKeyPressed(eKeyLeftArrow)) { // Left scan
    if (player.Loop != 8) {
      player.Animate(8, 3, eRepeat, eNoBlock);
    }
    // Scan Left
    gScanTimer--;
    if (gScanTimer < -20) {
      if (guiScannerReticle.Visible == false) {
        // Setup scanner position
        btnScannerReticle.X = 150;
        guiScannerReticle.Visible = true;
        btnScannerReticle.Animate(2, 0, 6, eRepeat, eNoBlock);
      }
      btnScannerReticle.X = 150 + (gScanTimer / 4);
    }
  }
  
  if (IsKeyPressed(eKeyRightArrow)) { // Right scan
    if (player.Loop != 9) {
      player.Animate(9, 3, eRepeat, eNoBlock);
    }
    // Scan Right
    gScanTimer++;
    if (gScanTimer > 20) {
      if (guiScannerReticle.Visible == false) {
        // Setup scanner position
        btnScannerReticle.X = 150;
        guiScannerReticle.Visible = true;
        btnScannerReticle.Animate(2, 0, 6, eRepeat, eNoBlock);
      }
      btnScannerReticle.X = 150 + (gScanTimer / 4);
    }
  }
}


function RopeMainProcess() {
  // Handles frame-by-frame rope logic
  RopeLockEngaged(); // Updates the rope lock state
  FaceScan();
  
  if (gRopeLocked == false) { // Rope is NOT locked, so accelerate
    gRopeVelocity += gRopeGravity / ((gRopeVelocity / 2.0) + 1.0);
    if (gRopeVelocity > gRopeMaxVelocity) {gRopeVelocity = gRopeMaxVelocity;}
  } else { // Rope IS locked, so halt & process other inputs
    if (gRopeVelocity >= gRopeBreakTension) {
      gRopeSnapped = true;
      while (player.y < 420) {
        player.y += 10;
        Wait(1);
      }
    }
    
    if (gRopeVelocity > 0.0) { // If we had velocity and locked,  we now stop
      gRopeVelocity = gRopeVelocity * -1.0; // Velocity is set to negative value so it can be used to gauge animation type needed in room 11 script
    }
    
  }
} export RopeMainProcess;