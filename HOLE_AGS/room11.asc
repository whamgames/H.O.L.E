// room script file

float PlayerPositionAccurate = 1280.0;

function GenerateNewPOI() {
  // Generate 1-6 POI for the span of oWalls2 so they are ready,  alternate between set 1 and set 2 to avoid overlap
  int MaxPOI = 1;
  int POIgenerated = 0;
  int NextObjectIDToUse = -1;
  if (gDepthLayer > 4) {MaxPOI++;}
  if (gDepthLayer > 8) {MaxPOI++;}
  if (gDepthLayer > 12) {MaxPOI++;}
  if (gDepthLayer > 16) {MaxPOI++;}
  if (gDepthLayer > 22) {MaxPOI++;}
  
  if (gNextPOIBatch == 0) { // Batch is 0,  use objects 4-9
    gNextPOIBatch = 1;
    NextObjectIDToUse = 4;
  } else {                  // Batch is 1,  use objects 10-15
    gNextPOIBatch = 0;
    NextObjectIDToUse = 10;
  }
  
  // TODO: Generate actually random POI,  X coordinate range depends on depth level used
  
  // Tester,  just create one simple POI for testing
  if (object[4].Y < 0) {
    object[4].Graphic = 23;
    object[4].X = 262 + Random(32);
    object[4].Y = oWalls2.Y - 120 - Random(860);
    object[4].Name = "POI";
  }
}


function UpdateWallSectionGraphics() {
  // We have moved down a level
  // Set oWalls1 visual and position to that of oWalls2
  oWalls1.Graphic = oWalls2.Graphic;
  oWalls2.Graphic = 0;
  oWalls1.X = 0;
  oWalls1.Y = oWalls2.Y;
  // Update oWalls2 graphic and position for next cycle
  oWalls2.X = 0;
  oWalls2.Y = oWalls1.Y + 1280;
  oWalls2.Graphic = 12;
  PlayerPositionAccurate += 1280.0;
  GenerateNewPOI();
}


function room_Load()
{
  cEgo.Transparency = 0; // Restore player character visibility
}

function room_AfterFadeIn()
{
  Display("You have entered the game, this is where the tutorial will take place!");
  // TODO: Player intro drop animation,  scripted
}

function room_RepExec()
{   
    int POIObjectYStart = 0;
    int POIObjectYEnd = 0;
    int POIObjectID = 4;
    if (gRopeSnapped == true) { // Trigger game end animation if rope has snapped
      RestartGame();
    }
    
    if (gRopeVelocity < 0.0) { // Just stopped, so animate the stop
      // TODO: Animate stop
      deLabStopVel.Text = String.Format("STP: %f", gRopeVelocity);
      gRopeVelocity = 0.0;
    }
    
    if (gRopeVelocity > 0.0) { // Not stopped and we have velocity, so calculate new position and animate wall Y movement
      PlayerPositionAccurate -= gRopeVelocity / 1.0;
      POIObjectYStart = oWalls1.Y;
      oWalls1.Y = FloatToInt(PlayerPositionAccurate, eRoundNearest);
      POIObjectYEnd = oWalls1.Y;
      
      if (POIObjectYStart != POIObjectYEnd) { // Walls have moved up, so update POI positions to match
        int POIMoveDist = POIObjectYStart - POIObjectYEnd;
        while (POIObjectID <= 12) {
          object[POIObjectID].Y = object[POIObjectID].Y - POIMoveDist;
          POIObjectID++;
        }
      }
      
      if (oWalls1.Y > -640) {
        oWalls2.Y = oWalls1.Y + 1280;
      } else {
        UpdateWallSectionGraphics();
        gDepthLayer += 1;
        deLabLevel.Text = String.Format("LVL: %d", gDepthLayer);
      }
    }
}
